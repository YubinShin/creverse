// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "./generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id          Int          @id @default(autoincrement())
  name        String
  createdAt   DateTime     @default(now()) @map("created_at")
  submissions Submission[]

  @@map("student")
}

model Submission {
  id                  Int             @id @default(autoincrement())
  studentId           Int             @map("student_id")
  student             Student         @relation(fields: [studentId], references: [id])
  componentType       String          @map("component_type")
  submitText          String          @map("submit_text")
  status              String          @default("PENDING")
  retryCount          Int             @default(0) @map("retry_count")
  lastError           String?         @map("last_error")
  score               Int?
  feedback            String?
  highlights          Json?
  highlightSubmitText String?         @map("highlight_submit_text")
  videoPath           String?         @map("video_path") // 로컬 경로
  audioPath           String?         @map("audio_path") // 로컬 경로
  videoUrl            String?         @map("video_url") // Blob URL
  audioUrl            String?         @map("audio_url") // Blob URL
  apiLatency          Int?            @map("api_latency")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  logs                SubmissionLog[]
  revisions           Revision[]

  @@map("submission")
}

model SubmissionLog {
  id           Int        @id @default(autoincrement())
  submissionId Int        @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id])
  phase        String
  uri          String
  status       String
  latencyMs    Int?       @map("latency_ms")
  traceId      String?    @map("trace_id")
  message      String?
  createdAt    DateTime   @default(now()) @map("created_at")

  @@map("submission_log")
}

model Revision {
  id           Int        @id @default(autoincrement())
  submissionId Int        @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id])
  prevStatus   String     @map("prev_status")
  newStatus    String     @map("new_status")
  reason       String?
  createdAt    DateTime   @default(now()) @map("created_at")

  @@map("revision")
}

model HttpLog {
  id        Int      @id @default(autoincrement())
  uri       String
  method    String
  status    Int
  latencyMs Int?     @map("latency_ms")
  traceId   String?  @map("trace_id")
  error     String?
  createdAt DateTime @default(now()) @map("created_at")

  // 조회 성능용 인덱스
  @@index([createdAt], map: "idx_http_log_created_at")
  @@index([uri], map: "idx_http_log_uri")
  @@index([traceId], map: "idx_http_log_trace")
  @@map("http_log")
}
